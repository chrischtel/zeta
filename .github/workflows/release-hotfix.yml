name: Release Hotfix

on:
  workflow_dispatch:
    inputs:
      hotfixBranch:
        description: 'Hotfix branch name (e.g., hotfix/fix-critical-bug)'
        required: true
      targetBranch:
        description: 'Target branch (usually main)'
        required: true
        default: 'main'
      bumpType:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor

jobs:
  release-hotfix:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract_version.outputs.version }}
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - name: Checkout hotfix branch
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.inputs.hotfixBranch }}
          fetch-depth: 0
      
      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.14.0
      
      - name: Run Tests
        run: zig build test
      
      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions"
      
      - name: Execute Version Bump
        shell: pwsh
        run: |
          ./release.ps1 ${{ github.event.inputs.bumpType }}
      
      - name: Extract Version
        id: extract_version
        shell: pwsh
        run: |
          $versionLine = Select-String -Path "build.zig" -Pattern 'const VERSION'
          if ($versionLine -match 'const VERSION = "(.*?)"') {
            $version = $Matches[1]
            echo "version=$version" >> $env:GITHUB_OUTPUT
          }
      
      - name: Merge to Target Branch
        run: |
          git checkout ${{ github.event.inputs.targetBranch }}
          git pull
          git merge --no-ff ${{ github.event.inputs.hotfixBranch }} -m "Merge hotfix: ${{ github.event.inputs.hotfixBranch }}"
          git push origin ${{ github.event.inputs.targetBranch }}
      
      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: "v${{ steps.extract_version.outputs.version }}"
          name: "Hotfix: v${{ steps.extract_version.outputs.version }}"
          body_path: CHANGELOG.md
          draft: false
          prerelease: false
      
      - name: Merge back to develop
        run: |
          git fetch origin develop
          git checkout develop
          git pull
          git merge --no-ff ${{ github.event.inputs.hotfixBranch }} -m "Merge hotfix: ${{ github.event.inputs.hotfixBranch }} back to develop"
          git push origin develop
      
      - name: Close associated PRs
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const hotfixName = context.payload.inputs.hotfixBranch;
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: hotfixName
            });
            
            for (const pr of prs.data) {
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                state: 'closed'
              });
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: `Closed automatically: changes from this hotfix have been released in v${{ steps.extract_version.outputs.version }} and merged to both main and develop.`
              });
            }

  build-and-upload:
    needs: release-hotfix
    uses: ./.github/workflows/build-and-upload-release.yml
    with:
      upload_url: ${{ needs.release-hotfix.outputs.upload_url }}
      ref_name: ${{ needs.release-hotfix.outputs.version }}
    secrets: inherit
